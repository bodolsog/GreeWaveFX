<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0px; padding: 0px }
        #map_canvas { height: 100%; background-color: #666970; }
        .context-menu {
            display: none;
            position: absolute;
            z-index: 10;
            padding: 0;
            width: 160px;
            background-color: #fff;
            border: solid 1px #dfdfdf;
            box-shadow: 1px 1px 2px #cfcfcf;
            font-size: 14px;
        }
        .context-menu--active {
            display: block;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }

        .context-menu__item{
            padding: 5px;
        }
        .context-menu__items{
            margin: 0;
        }
    </style>
    <script type="text/javascript">
        /*
        * Add to head script file from Google API with Google API key from config.
        */
        var head = document.getElementsByTagName('head')[0];
        var key = properties.getGoogleAPIKey();

        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'http://maps.google.com/maps/api/js?key=' + key + '&sensor=false';
        head.appendChild(script);
    </script>
    <script type="text/javascript">
        function test(tex){
            document.getElementById('test').innerHTML = tex;
        }

        var markersMap = {};
        var activeMarkerId;
        var menuMarkerId;

        function initialize() {
            var latlng = new google.maps.LatLng(52.03, 23.14);
            var myOptions = {
                zoom: 15,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                navigationControl: false,
                streetViewControl: false,
                backgroundColor: "#666970",
                zoomControl: false,
                scaleControl: true
            };

            var menu = document.querySelector("#context-menu");
            var menuWasActive = false;

            document.map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
            document.geocoder = new google.maps.Geocoder();
            document.service = new google.maps.DistanceMatrixService;
            document.directionsService = new google.maps.DirectionsService;
            document.directionsDisplay = new google.maps.DirectionsRenderer;

            overlay = new google.maps.OverlayView();
            overlay.draw = function () {};
            overlay.setMap(document.map);

            document.directionsDisplay.setMap(document.map);
            markersId = 0;

            var menuItem = menu.querySelectorAll(".context-menu__item")
            for(i=0; i<menuItem.length; i++){
                menuItem[i].addEventListener('click', function(){
                    action = this.querySelector('a').getAttribute("data-action");
                    if(action == "connect2w" || action == "connect1w"){
                        controller.connectMarkers(action, activeMarkerId, menuMarkerId);
                        pointA = markersMap[activeMarkerId].getPosition();
                        pointB = markersMap[menuMarkerId].getPosition();

                        document.service.getDistanceMatrix({
                            origins: [pointA],
                            destinations: [pointB],
                            travelMode: google.maps.TravelMode.DRIVING,
                            unitSystem: google.maps.UnitSystem.METRIC,
                            avoidHighways: true,
                            avoidTolls: true
                        }, function(response, status){
                            if (status !== google.maps.DistanceMatrixStatus.OK) {
                                test('Error was: ' + status);
                            } else {
                                test(response.rows[0].elements[0].distance.value);
                            }
                        });

                        document.directionsService.route({
                            origin: pointA,
                            destination: pointB,
                            travelMode: google.maps.TravelMode.DRIVING
                        }, function(response, status) {
                            if (status === google.maps.DirectionsStatus.OK) {
                                document.directionsDisplay.setDirections(response);
                            } else {
                                test('Directions request failed due to ' + status);
                            }
                        });
                    }
                });
            }
//TODO opacity=1 by hover
            google.maps.event.addListener(document.map, 'mousedown', function(){
                if(menu.classList.contains("context-menu--active")){
                    menu.classList.remove("context-menu--active");
                    menuWasActive = true;
                    menuMarkerId = null;
                }
            });
            google.maps.event.addListener(document.map, 'click', function (event) {
                if(menuWasActive)
                    menuWasActive = false;
                else{
                    // Increment id-number
                    markersId++;

                    // Create id
                    var markerId = markersId;
                    activeMarkerId = markerId;

                    // Create marker
                    var marker = new google.maps.Marker({
                        position: event.latLng,
                        draggable: true,
                        title: "#"+markerId,
                        map: document.map
                    });

                    // Add marker to lists.
                    controller.addMarker(markerId, marker.getPosition().lat(), marker.getPosition().lng());
                    markersMap[markerId] = marker;

                    var infowindow = new google.maps.InfoWindow({
                        content: infowindowContent(marker)
                    });

                    marker.addListener('click', function() {
                        infowindow.open(document.map, marker);
                    });

                    google.maps.event.addListener(marker, 'drag', function(){
                        if(marker.getTitle().search('(updating...)') == -1)
                            marker.setTitle(marker.getTitle()+" (updating...)");
                        infowindow.setContent(infowindowContent(marker));
                        /*if(menu.classList.contains("context-menu--active")){
                         menu.classList.remove("context-menu--active");
                         menuMarkerId = null;
                         }
                         else
                         controller.setClickedFocus(markerId);*/
                    });
                    google.maps.event.addListener(marker, 'position_changed', function () {
                        newLatLng = marker.getPosition();
                        controller.setMarkerLatLng(markerId, newLatLng.lat(), newLatLng.lng());
                        backThread.cancelThreads(markerId);
                        backThread.getStreetsNames(markerId, newLatLng.lat(), newLatLng.lng());
                    });
                    google.maps.event.addListener(marker, 'title_changed', function () {
                        infowindow.setContent(infowindowContent(marker));
                    });
                    /* Add listeners for menu*/
                    //google.maps.event.addListener(marker, 'click', function(){
                    /*    /!*if(menu.classList.contains("context-menu--active")) {
                            menu.classList.remove("context-menu--active");
                            menuMarkerId = null;
                        }
                        else
                            controller.setClickedFocus(markerId);*!/
                    });*/


                    google.maps.event.addListener(marker, 'rightclick', function () {
                        //TODO new method to get points
                        var point = overlay.getProjection().fromLatLngToDivPixel(marker.getPosition());
                        menu.style.left = point.x + "px";
                        menu.style.top = point.y + "px";
                        menu.classList.add("context-menu--active");
                        menuWasActive = true;
                        menuMarkerId = markerId;
                    });
                    /* End listeners */

                    backThread.getStreetsNames(markerId, event.latLng.lat(), event.latLng.lng());
                }
            });

        }

        function infowindowContent(marker){
            return "<div class='infowindow-content'>" +
                      "<dl>" +
                        "<dt>Cross:</dt>" +
                         "<dd>"+ marker.getTitle() +"</dd>" +
                        "<dt>Coordinates:</dt>" +
                         "<dd>Lat:"+ marker.getPosition().lat() +", Lng: "+ marker.getPosition().lng() +"</dd>" +
                        "<dt>Type:</dt>" +
                         "<dd>-</dd>" +
                      "</dl>" +
                    "</div>";
        }

        function setCrossName(id, newName){
            markersMap[id].setTitle(newName);
        }

        /**
         * Delete Marker from map, set them to null and remove hash from markersMap.
         * @param id Marker's id
         */
        function deleteMarker(id){
            markersMap[id].setMap(null);
            markersMap[id] = null;
            delete(markersMap[id]);
        }

        function getCrossName(id, lat, lng){
            latLng = {lat: lat, lng: lng};
            getStreetName(id, latLng);
        }

        function getStreetName(id, latLng){
            document.geocoder.geocode({'location': latLng}, function(results, status) {
                if(status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT){
                    setTimeout(function(){
                        backThread.startThread(id, latLng['lat'], latLng['lng']);
                    }, 1000);

                } else if(status === google.maps.GeocoderStatus.OK) {
                    backThread.putToMap(id, results[0].address_components[1].short_name);
                } else {
                    backThread.error(status);
                }
            });
        }

        function setMarkerFocus(oldMarkerId, newMarkerId){
            activeMarkerId = newMarkerId;
            if(oldMarkerId in markersMap)
                markersMap[oldMarkerId].setOpacity(0.7);

            if(newMarkerId in markersMap) {
                markersMap[newMarkerId].setOpacity(1.0);
                markersMap[newMarkerId].setAnimation(google.maps.Animation.BOUNCE);
                window.setTimeout(function () {
                    markersMap[newMarkerId].setAnimation(null);
                }, 1500);
            }
        }

    </script>

</head>
<body onload="initialize();">
<div id="test"></div>
<div id="map_canvas" style="width:100%; height:100%"></div>

<nav id="context-menu" class="context-menu">
    <ul class="context-menu__items">
        <li class="context-menu__item">
            <a href="#" class="context-menu__link" data-action="connect2w">Connect with this</a>
        </li>
        <li class="context-menu__item">
            <a href="#" class="context-menu__link" data-action="connect1w">Connect one way to this</a>
        </li>
    </ul>
</nav>
</body>
</html>