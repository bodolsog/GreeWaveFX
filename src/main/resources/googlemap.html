<!DOCTYPE html>
<html>
<head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <style type="text/css">
        html { height: 100% }
        body { height: 100%; margin: 0px; padding: 0px }
        #map_canvas { height: 100%; background-color: #666970; }
        .context-menu {
            display: none;
            position: absolute;
            z-index: 10;
            padding: 0;
            width: 180px;
            background-color: #f8f8f8;
            border: solid 1px #b4b4b4;
            box-shadow: 1px 1px 2px #cfcfcf;
            font-size: 12px;
        }
        .context-menu--active {
            display: block;
        }
        ul {
            list-style-type: none;
            padding: 0;
        }

        .context-menu__item{
            padding: 5px;
        }
        .context-menu__items{
            margin: 0;
        }
        .context-menu__link{
            text-decoration: none;
        }
    </style>
    <script type="text/javascript">
        /* Add to head script file from Google API with Google API key from config. */
        var head = document.getElementsByTagName('head')[0];
        var key = properties.getGoogleAPIKey();

        var script = document.createElement('script');
        script.type = 'text/javascript';
        script.src = 'http://maps.google.com/maps/api/js?key=' + key + '&sensor=false';
        head.appendChild(script);
    </script>
    <script type="text/javascript">
        function test(tex){
            document.getElementById('test').innerHTML = tex;
        }

        /* TODO: potrzebne? */
        var activeMarkerId;
        var menuMarkerId;

        function initialize() {
            /* Domestic center on Biala Podlaska. */
            var latlng = new google.maps.LatLng(52.03, 23.14);

            var map = new google.maps.Map(document.getElementById("map_canvas"), {
                zoom: 15,
                center: latlng,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                mapTypeControl: false,
                navigationControl: false,
                streetViewControl: false,
                backgroundColor: "#666970",
                zoomControl: false,
                scaleControl: true
            });

            /* Services */
            var directionsService = new google.maps.DirectionsService;

            var overlay = new google.maps.OverlayView();
            overlay.draw = function () {};
            overlay.setMap(map);

//            var directionsDisplay = new google.maps.DirectionsRenderer;
//            directionsDisplay.setMap(map);
//            geocoder = new google.maps.Geocoder();
//            service = new google.maps.DistanceMatrixService;
//            directionsService = new google.maps.DirectionsService;
//





//            var menuItem = menu.querySelectorAll(".context-menu__item")
//            for(i=0; i<menuItem.length; i++){
//                menuItem[i].addEventListener('click', function(){
//                    action = this.querySelector('a').getAttribute("data-action");
//                    if(action == "connect2w" || action == "connect1w"){
//                        controller.connectMarkers(action, activeMarkerId, menuMarkerId);
//                        pointA = markersMap[activeMarkerId].getPosition();
//                        pointB = markersMap[menuMarkerId].getPosition();
//
//                        document.service.getDistanceMatrix({
//                            origins: [pointA],
//                            destinations: [pointB],
//                            travelMode: google.maps.TravelMode.DRIVING,
//                            unitSystem: google.maps.UnitSystem.METRIC,
//                            avoidHighways: true,
//                            avoidTolls: true
//                        }, function(response, status){
//                            if (status !== google.maps.DistanceMatrixStatus.OK) {
//                                test('Error was: ' + status);
//                            } else {
//                                test(response.rows[0].elements[0].distance.value);
//                            }
//                        });
//
//                        document.directionsService.route({
//                            origin: pointA,
//                            destination: pointB,
//                            travelMode: google.maps.TravelMode.DRIVING
//                        }, function(response, status) {
//                            if (status === google.maps.DirectionsStatus.OK) {
//                                document.directionsDisplay.setDirections(response);
//                            } else {
//                                test('Directions request failed due to ' + status);
//                            }
//                        });
//                    }
//                });
//            }

//            google.maps.event.addListener(map, 'mousedown', function(){
//                if(menu.classList.contains("context-menu--active")){
//                    menu.classList.remove("context-menu--active");
//                    menuWasActive = true;
//                    menuMarkerId = null;
//                }
//            });

            var activeMenu;
            map.addListener('mousedown', function(){
                if(activeMenu != null)
                    if(activeMenu.active())
                        activeMenu.hide();
                    else
                        activeMenu = null;
            });

            map.addListener('click', function (event) {
                if(activeMenu == null) {
                    // Create marker
                    var marker = new google.maps.Marker({
                        position: event.latLng,
                        draggable: true,
                        map: map
                    });

                    calibrateMarkerPosition(directionsService, marker);

                    /* Context menu */
                    marker.contextMenu = {
                        body: document.querySelector("#context-menu"),
                        activeClass: "context-menu--active",
                        active: function () {
                            return this.body.classList.contains(this.activeClass);
                        },
                        show: function () {
                            this.anchor();
                            this.body.classList.add(this.activeClass);
                            activeMenu = this;
                        },
                        hide: function () {
                            this.body.classList.remove(this.activeClass);
                        },
                        toggle: function () {
                            if (this.active())
                                this.hide();
                            else
                                this.show();
                        },
                        anchor: function () {
                            var point = overlay.getProjection().fromLatLngToContainerPixel(marker.getPosition());
                            this.body.style.left = point.x + "px";
                            this.body.style.top = point.y + "px";
                        }
                    };

                    // Add marker to lists.
                    controller.addMarker(marker);

                    // Create infowindow
                    marker.infowindow = new google.maps.InfoWindow({
                        content: infowindowContent(marker)
                    });


                    /* Marker listeners */
                    marker.addListener('click', function () {
                        marker.contextMenu.hide();
                        marker.infowindow.open(map, marker);
                    });

                    marker.addListener('drag', function () {
                        marker.contextMenu.hide();
                    });
                    marker.addListener('dragend', function () {
                        calibrateMarkerPosition(directionsService, marker);
                    });

                    marker.addListener('rightclick', function () {
                        marker.contextMenu.toggle();
                    });

                    //                    var point = overlay.getProjection().fromLatLngToContainerPixel(marker.getPosition());

                    //                    google.maps.event.addListener(map, 'center_changed', function(){
                    //                        hideContentMenu(menuMarkerId);
                    //                        point = overlay.getProjection().fromLatLngToContainerPixel(marker.getPosition());
                    //                    });
                    //                    google.maps.event.addListener(marker, 'drag', function(){
                    //                        if(marker.getTitle().search('(updating...)') == -1)
                    //                            marker.setTitle(marker.getTitle()+" (updating...)");
                    //                        marker.infowindow.setContent(infowindowContent(marker));
                    //                        hideContentMenu(menuMarkerId);
                    //                        point = overlay.getProjection().fromLatLngToContainerPixel(marker.getPosition());
                    //                    });
                    //                    google.maps.event.addListener(marker, 'position_changed', function () {
                    //                        newLatLng = marker.getPosition();
                    ////                        controller.setMarkerLatLng(markerId, newLatLng.lat(), newLatLng.lng());
                    ////                        backThread.cancelThreads(markerId);
                    ////                        backThread.getStreetsNames(markerId, newLatLng.lat(), newLatLng.lng());
                    //                    });
                    //                    google.maps.event.addListener(marker, 'title_changed', function () {
                    //                        marker.infowindow.setContent(infowindowContent(marker));
                    //                    });
                    /* Add listeners for menu*/
                    //google.maps.event.addListener(marker, 'click', function(){
                    /*    /!*if(menu.classList.contains("context-menu--active")) {
                     menu.classList.remove("context-menu--active");
                     menuMarkerId = null;
                     }
                     else
                     controller.setClickedFocus(markerId);*!/
                     });*/


                    //                    marker.addListener('rightclick', function () {
                    //                        //TODO new method to get points
                    //                        menu.style.left = point.x + "px";
                    //                        menu.style.top = point.y + "px";
                    //                        menu.classList.add("context-menu--active");
                    //                        menuWasActive = true;
                    //                        menuMarkerId = markerId;
                    //                    });
                    /* End listeners */

                    //backThread.getStreetsNames(markerId, event.latLng.lat(), event.latLng.lng());
                    //                }
                }
            });

        }


//        function hideContentMenu(menuMarkerId){
//            if(menu.classList.contains("context-menu--active")){
//                menu.classList.remove("context-menu--active");
//                menuMarkerId = null;
//            }
//        }



//        function getCrossName(id, lat, lng){
//            latLng = {lat: lat, lng: lng};
//            getStreetName(id, latLng);
//        }

//        function getStreetName(id, latLng){
//            document.geocoder.geocode({'location': latLng}, function(results, status) {
//                if(status === google.maps.GeocoderStatus.OVER_QUERY_LIMIT){
//                    setTimeout(function(){
//                        backThread.startThread(id, latLng['lat'], latLng['lng']);
//                    }, 1000);
//
//                } else if(status === google.maps.GeocoderStatus.OK) {
//                    backThread.putToMap(id, results[0].address_components[1].short_name);
//                } else {
//                    backThread.error(status);
//                }
//            });
//        }

//        function setMarkerFocus(oldMarkerId, newMarkerId){
//            activeMarkerId = newMarkerId;
//            if(oldMarkerId in markersMap)
//                markersMap[oldMarkerId].setOpacity(0.7);
//
//            if(newMarkerId in markersMap) {
//                markersMap[newMarkerId].setOpacity(1.0);
//                markersMap[newMarkerId].setAnimation(google.maps.Animation.BOUNCE);
//                window.setTimeout(function () {
//                    markersMap[newMarkerId].setAnimation(null);
//                }, 1500);
//            }
//        }

        /**
         *
         * @param marker
         * @returns {string}
         */
        function infowindowContent(marker){
            return  "<div class='infowindow-content'>" +
                    "   <dl>" +
                    "       <dt>Coordinates:</dt>" +
                    "       <dd>Lat:"+ marker.getPosition().lat() +", Lng: "+ marker.getPosition().lng() +"</dd>" +
                    "       <dt>Type:</dt>" +
                    "       <dd>-</dd>" +
                    "   </dl>" +
                    "</div>";
        }

        /**
         *
         * @param directionsService
         * @param marker
         */
        function calibrateMarkerPosition(directionsService, marker) {
            var lat = marker.getPosition().lat();
            var lng = marker.getPosition().lng();
            var d = 0.0002;

            var north = {lat: (lat+d), lng: lng};
            var south = {lat: (lat-d), lng: lng};
            var east = {lat: lat, lng: (lng+d)};
            var west = {lat: lat, lng: (lng-d)};

            directionsService.route(
                directionsServiceOptions(north, east), function (response, status){
                    if (status === google.maps.DirectionsStatus.OK)
                        if(getCalibration(response.routes[0].legs[0], marker, lat, lng, d))
                            return;
                    directionsService.route(
                        directionsServiceOptions(south, west), function (response, status){
                            if (status === google.maps.DirectionsStatus.OK)
                                if(getCalibration(response.routes[0].legs[0], marker, lat, lng, d))
                                    return;
                });
            });
        }

        /**
         *
         * @param origin
         * @param destination
         * @returns {{origin: *, destination: *, travelMode: *}}
         */
        function directionsServiceOptions(origin, destination){
            return {
                origin: origin,
                destination: destination,
                travelMode: google.maps.TravelMode.DRIVING
            };
        }

        /**
         *
         * @param way
         * @param marker
         * @param lat
         * @param lng
         * @param d
         * @returns {boolean}
         */
        function getCalibration(way, marker, lat, lng, d){
            for(var i=0; i<way.steps.length; i++){
                if(
                        Math.abs(way.steps[i].end_location.lat()-lat) < (d/2)
                        && Math.abs(way.steps[i].end_location.lng()-lng) < (d/2)
                ){
                    marker.setPosition(way.steps[i].end_location);
                    marker.infowindow.setContent(infowindowContent(marker));
                    return true;
                }
            }
        }
    </script>

</head>
<body onload="initialize();">
<menu type="context" id="mymenu">
    <menuitem label="Refresh"></menuitem>
    <menuitem label="Twitter"></menuitem>
</menu>
<div id="test"></div>
<div id="map_canvas" style="width:100%; height:100%"></div>

<nav id="context-menu" class="context-menu">
    <ul class="context-menu__items">
        <li class="context-menu__item">
            <a href="#" class="context-menu__link" data-action="connect2w">Connect with this</a>
        </li>
        <li class="context-menu__item">
            <a href="#" class="context-menu__link" data-action="connect1w">Connect one way to this</a>
        </li>
        <li class="context-menu__item">
            <a href="#" class="context-menu__link" data-action="setCrossType4">Set cross type (4way)</a>
        </li>
        <li class="context-menu__item">
            <a href="#" class="context-menu__link" data-action="setCrossType3">Set cross type (3way)</a>
        </li>
    </ul>
</nav>
</body>
</html>